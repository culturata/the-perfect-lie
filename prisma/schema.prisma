// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Course {
  id          String   @id @default(cuid())
  name        String
  designer    String?
  dateAdded   DateTime
  lastUpdated DateTime
  downloadUrl String
  sourceUrl   String? // Original Pakman Studios URL

  // CSV fields from Pakman Studios
  server      String? // Server type
  location    String? // Real-world location
  version     String? // Version number
  tourStop    Boolean  @default(false) // Is this a tour stop course
  majorVenue  Boolean  @default(false) // Is this a major venue
  historic    Boolean  @default(false) // Is this a historic course

  // Optional fields (can be added by users/admin)
  description String? @db.Text
  imageUrl    String?
  courseType  String? // links, parkland, desert, etc.
  holes       Int? // 9 or 18
  difficulty  Int? // 1-5 rating
  fileSize    String?

  // Relationships
  favorites Favorite[]
  reviews   Review[]
  videos    YouTubeVideo[] // Flyover videos for this course
  comments  Comment[] // Comments on this course
  collectionItems CollectionItem[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dateAdded])
  @@index([designer])
  @@index([name])
  @@index([tourStop])
  @@index([majorVenue])
  @@index([historic])
}

model YouTubeVideo {
  id           String   @id @default(cuid())
  videoId      String   @unique // YouTube video ID
  title        String
  description  String?  @db.Text
  thumbnailUrl String
  publishedAt  DateTime
  channelTitle String
  playlistType String // 'flyovers' or 'golf'
  duration     String?
  viewCount    Int?

  // Course relationship (for flyover videos)
  courseId String? // Linked course
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([playlistType])
  @@index([publishedAt])
  @@index([courseId])
}

model Resource {
  id          String           @id @default(cuid())
  name        String
  description String?          @db.Text
  url         String
  affiliateUrl String?
  imageUrl    String?
  category    ResourceCategory
  subcategory String?

  // Additional fields
  price    String?
  brand    String?
  featured Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}

enum ResourceCategory {
  LAUNCH_MONITOR
  RETAILER
  EQUIPMENT
  SOFTWARE
  COMMUNITY
  ONLINE_PLAY
  TOURNAMENTS
  SIMULATOR_BUILDING
  BEST_PRACTICES
  TRAINING_AIDS
  COURSE_DESIGN
  STREAMING_TOOLS
}

model User {
  id        String  @id // Clerk user ID
  email     String  @unique
  username  String? @unique
  firstName String?
  lastName  String?
  avatarUrl String?
  isBozo    Boolean @default(false) // Shadowbanned user (only they see their content)

  // Relationships
  favorites            Favorite[]
  reviews              Review[]
  comments             Comment[]
  notifications        Notification[]        @relation("NotificationReceiver")
  triggeredNotifications Notification[]      @relation("NotificationTriggerer")
  preferences          UserPreferences?
  collections          Collection[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Email notification settings
  emailOnReply       Boolean @default(true)
  emailOnMention     Boolean @default(true)
  emailDigest        Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NewsletterSubscription {
  id     String  @id @default(cuid())
  email  String  @unique
  userId String? @unique // Optional - for logged-in users
  name   String? // Optional name

  // Subscription status
  isActive   Boolean @default(true)
  isVerified Boolean @default(false) // For email verification if needed

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  unsubscribedAt DateTime?

  @@index([email])
  @@index([userId])
}

model Favorite {
  id       String @id @default(cuid())
  userId   String
  courseId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId])
}

model Review {
  id       String  @id @default(cuid())
  userId   String
  courseId String
  rating   Int // 1-5
  title    String? // Optional review title
  content  String? @db.Text // Review text

  // Helpful votes
  helpfulCount Int @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
}

model Comment {
  id       String  @id @default(cuid())
  userId   String
  courseId String
  content  String  @db.Text

  // Threading support
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  // Metadata
  isEdited Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([userId])
  @@index([parentId])
}

model Notification {
  id     String           @id @default(cuid())
  userId String // User who receives the notification
  type   NotificationType

  // Notification content
  title   String
  message String

  // Related entities
  courseId  String?
  commentId String?
  reviewId  String?

  // Notification metadata
  isRead      Boolean  @default(false)
  triggeredBy String? // User ID who triggered the notification

  // Relationships
  user      User  @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)
  triggerer User? @relation("NotificationTriggerer", fields: [triggeredBy], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  COMMENT_REPLY
  REVIEW_REPLY
  MENTION
  COURSE_UPDATE
}

model SyncLog {
  id             String      @id @default(cuid())
  type           SyncType
  status         SyncStatus
  startedAt      DateTime    @default(now())
  completedAt    DateTime?
  itemsProcessed Int?
  errorMessage   String?     @db.Text

  @@index([type, startedAt])
}

enum SyncType {
  COURSES
  YOUTUBE_FLYOVERS
  YOUTUBE_GOLF
}

enum SyncStatus {
  RUNNING
  SUCCESS
  FAILED
}

model Article {
  id          String          @id @default(cuid())
  title       String
  slug        String          @unique
  excerpt     String          @db.Text
  content     String          @db.Text
  category    ArticleCategory
  subcategory String?

  // SEO and metadata
  metaTitle       String?
  metaDescription String?

  // Article attributes
  readTime    String? // e.g., "8 min read"
  featured    Boolean @default(false)
  published   Boolean @default(false)
  order       Int     @default(0) // For ordering within category

  // Filters for sidebar navigation
  budgetTier  BudgetTier?
  roomType    RoomType?
  ceilingHeight CeilingHeight?
  buildStyle  BuildStyle?

  // Related content
  relatedArticles String[] // Array of article IDs

  // Relationships
  collectionItems CollectionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  publishedAt DateTime?

  @@index([category])
  @@index([slug])
  @@index([published])
}

enum ArticleCategory {
  START_HERE
  LAUNCH_MONITORS
  PROJECTORS
  PC_SOFTWARE
  SCREENS_ENCLOSURES
  FLOORING_TURF
  LIGHTING_POWER
  DIY_BUILDS
  TUNING_MAINTENANCE
  EXAMPLE_BUILDS
}

enum BudgetTier {
  STARTER
  MID
  PREMIUM
}

enum RoomType {
  GARAGE
  BASEMENT
  SPARE_ROOM
  SHED
}

enum CeilingHeight {
  UNDER_9
  NINE_TO_TEN
  OVER_10
}

enum BuildStyle {
  DIY
  HYBRID
  TURNKEY
}

model Collection {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?  @db.Text
  isPublic    Boolean  @default(false) // For future sharing feature

  // Relationships
  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CollectionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model CollectionItem {
  id           String       @id @default(cuid())
  collectionId String
  itemType     CollectionItemType

  // One of these will be set based on itemType
  courseId  String?
  articleId String?

  // Relationships
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  course     Course?    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  article    Article?   @relation(fields: [articleId], references: [id], onDelete: Cascade)

  addedAt DateTime @default(now())

  @@unique([collectionId, itemType, courseId, articleId])
  @@index([collectionId])
  @@index([courseId])
  @@index([articleId])
}

enum CollectionItemType {
  COURSE
  ARTICLE
}
