// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Course {
  id          String   @id @default(cuid())
  name        String
  designer    String?
  dateAdded   DateTime
  lastUpdated DateTime
  downloadUrl String
  sourceUrl   String? // Original Pakman Studios URL

  // CSV fields from Pakman Studios
  server      String? // Server type
  location    String? // Real-world location
  version     String? // Version number
  tourStop    Boolean  @default(false) // Is this a tour stop course
  majorVenue  Boolean  @default(false) // Is this a major venue
  historic    Boolean  @default(false) // Is this a historic course

  // Optional fields (can be added by users/admin)
  description String? @db.Text
  imageUrl    String?
  courseType  String? // links, parkland, desert, etc.
  holes       Int? // 9 or 18
  difficulty  Int? // 1-5 rating
  fileSize    String?

  // Relationships
  favorites Favorite[]
  reviews   Review[]
  videos    YouTubeVideo[] // Flyover videos for this course
  comments  Comment[] // Comments on this course

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dateAdded])
  @@index([designer])
  @@index([name])
  @@index([tourStop])
  @@index([majorVenue])
  @@index([historic])
}

model YouTubeVideo {
  id           String   @id @default(cuid())
  videoId      String   @unique // YouTube video ID
  title        String
  description  String?  @db.Text
  thumbnailUrl String
  publishedAt  DateTime
  channelTitle String
  playlistType String // 'flyovers' or 'golf'
  duration     String?
  viewCount    Int?

  // Course relationship (for flyover videos)
  courseId String? // Linked course
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([playlistType])
  @@index([publishedAt])
  @@index([courseId])
}

model Resource {
  id          String           @id @default(cuid())
  name        String
  description String?          @db.Text
  url         String
  affiliateUrl String?
  imageUrl    String?
  category    ResourceCategory
  subcategory String?

  // Additional fields
  price    String?
  brand    String?
  featured Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}

enum ResourceCategory {
  LAUNCH_MONITOR
  RETAILER
  EQUIPMENT
  SOFTWARE
  COMMUNITY
}

model User {
  id        String  @id // Clerk user ID
  email     String  @unique
  username  String? @unique
  firstName String?
  lastName  String?
  avatarUrl String?

  // Relationships
  favorites            Favorite[]
  reviews              Review[]
  comments             Comment[]
  notifications        Notification[]        @relation("NotificationReceiver")
  triggeredNotifications Notification[]      @relation("NotificationTriggerer")
  preferences          UserPreferences?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Email notification settings
  emailOnReply       Boolean @default(true)
  emailOnMention     Boolean @default(true)
  emailDigest        Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Favorite {
  id       String @id @default(cuid())
  userId   String
  courseId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId])
}

model Review {
  id       String  @id @default(cuid())
  userId   String
  courseId String
  rating   Int // 1-5
  title    String? // Optional review title
  content  String? @db.Text // Review text

  // Helpful votes
  helpfulCount Int @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
}

model Comment {
  id       String  @id @default(cuid())
  userId   String
  courseId String
  content  String  @db.Text

  // Threading support
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  // Metadata
  isEdited Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([userId])
  @@index([parentId])
}

model Notification {
  id     String           @id @default(cuid())
  userId String // User who receives the notification
  type   NotificationType

  // Notification content
  title   String
  message String

  // Related entities
  courseId  String?
  commentId String?
  reviewId  String?

  // Notification metadata
  isRead      Boolean  @default(false)
  triggeredBy String? // User ID who triggered the notification

  // Relationships
  user      User  @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)
  triggerer User? @relation("NotificationTriggerer", fields: [triggeredBy], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  COMMENT_REPLY
  REVIEW_REPLY
  MENTION
  COURSE_UPDATE
}

model SyncLog {
  id             String      @id @default(cuid())
  type           SyncType
  status         SyncStatus
  startedAt      DateTime    @default(now())
  completedAt    DateTime?
  itemsProcessed Int?
  errorMessage   String?     @db.Text

  @@index([type, startedAt])
}

enum SyncType {
  COURSES
  YOUTUBE_FLYOVERS
  YOUTUBE_GOLF
}

enum SyncStatus {
  RUNNING
  SUCCESS
  FAILED
}
