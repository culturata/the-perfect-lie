name: Auto PR and Merge for Claude branches

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Get commit details
        id: commit
        run: |
          TITLE=$(git log -1 --pretty=%s)
          BODY=$(git log -1 --pretty=%b)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head "${{ steps.branch.outputs.name }}" --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_pr.outputs.exists == 'false'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "${{ steps.commit.outputs.title }}" \
            --body "${{ steps.commit.outputs.body }}" \
            --base main \
            --head "${{ steps.branch.outputs.name }}")
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]*$')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            PR_NUMBER=${{ steps.check_pr.outputs.number }}
          else
            PR_NUMBER=${{ steps.create_pr.outputs.number }}
          fi
          gh pr merge $PR_NUMBER --auto --squash

      - name: Summary
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "âœ… Updated existing PR #${{ steps.check_pr.outputs.number }} with auto-merge enabled"
          else
            echo "âœ… Created new PR #${{ steps.create_pr.outputs.number }} with auto-merge enabled"
            echo "ðŸ”— ${{ steps.create_pr.outputs.url }}"
          fi
